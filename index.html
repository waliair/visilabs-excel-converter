<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visilabs Excel Converter</title>
    <style>
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <form enctype="multipart/form-data">
                    <div class="mt-3">
                        <input id="upload" type=file  name="files[]" class="form-control form-control-lg">
                    </div>
                </form>
            </div>
        </div>
        
        <div class="row mt-2">
            <div class="col-md-12">
              <ul class="nav nav-pills justify-content-center border border-default p-2" id="loadedSheetNames"></ul>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md-2 border border-default">
                <ul class="nav flex-column text-center nav-pills" id="resultOfJson"></ul>
            </div>
            <div class="col-md-10">
                <textarea name="" id="xlx_html" rows="30" class="form-control" readonly></textarea>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12 text-end">

                <button type="button" id="xl__json" class="btn btn-primary disabled"><i class="bi bi-clipboard"></i> Get Main JSON Data</button>
                <button type="button" id="copyofresult" class="btn btn-primary disabled"><i class="bi bi-clipboard"></i> Copy Output</button>
            </div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>
<script>
    document.getElementById('upload').addEventListener('change', handleFileSelect, false);
    $(document).on("click", ".dropdown-item", handleJSONObject);
    document.getElementById('xl__json').addEventListener("click",getJsonData,false);
    document.getElementById('copyofresult').addEventListener("click",copyAll,false);
    $(document).on("click", "#loadedSheetNames .nav-link", changeSheet);


    var stateObject = {};

    var ExcelToJSON = function() {

      this.parseExcel = function(file) {
        var reader = new FileReader();
        clearForNewExcel();
        reader.onload = function(e) {
          var data = e.target.result;
          var workbook = XLSX.read(data, {
            type: 'binary'
          });
          workbook.SheetNames.forEach(function(sheetName, idx) {
            var firstSheetLoop = idx == 0 ? true : false;
            var XL_row_object = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
            
            var hasExistsAnyUndefined = XL_row_object[0].undefined;

            if(hasExistsAnyUndefined) {
                alert("Lütfen yüklediğiniz excelde tüm headerlerin girildiğinden emin olun.");
                return true;
            }
            stateObject[sheetName] = XL_row_object;
            firstSheetLoop && loadDefaultHeader(sheetName);
            setSheetNames(sheetName, firstSheetLoop);
            openAccessControllerButtons();
          })
        };

        reader.onerror = function(ex) {
          console.log(ex);
        };

        reader.readAsBinaryString(file);
      };
  };

  function openAccessControllerButtons() {
      document.getElementById('xl__json').classList.remove('disabled');
      document.getElementById('copyofresult').classList.remove('disabled');
      return true;
  }

  function setSheetNames(sheetName, isFirstSheet) {
      var li = document.createElement("li");
      li.setAttribute("class", "nav-item");
      li.innerHTML = `
          <a class="nav-link ${isFirstSheet ? 'active' : ''}" data-value="${sheetName}" href="#">${sheetName}</a>
      `;
      document.getElementById('loadedSheetNames').append(li);
  }

  function changeSheet(e) {
      if(!e.target.classList.contains('active')) {
        $(document).find('#loadedSheetNames .nav-link.active').removeClass('active');
        e.target.classList.add('active');
        clearHeaders();
        var selectedSheet = e.target.dataset.value;
        setHeaders(selectedSheet);
      }
      
  }

  function loadDefaultHeader(sheetName) {
      setHeaders(sheetName);
  }

  function clearHeaders() {
    $(document).find('#resultOfJson').empty();
    return true;
  }

  function setHeaders(sheetName) {
      var item = getSheet(sheetName)[0];

      Object.keys(item).forEach(function(item) {
            var li = document.createElement("li");
            li.setAttribute("class", "nav-item dropdown mb-3");
            li.innerHTML = `
            <a class="nav-link dropdown-toggle added-after" data-bs-toggle="dropdown" href="#" role="button" data-value="${item}" aria-expanded="false"><i class="bi bi-x-diamond-fill"></i> ${item}</a>
                <ul class="dropdown-menu w-100 text-center">
                    <li><h6 class="dropdown-header">Target Rules</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" data-type="array" data-value="${item}" href="#"><i class="bi bi-arrow-return-right"></i> Extract For Array</a></li>
                    <li><a class="dropdown-item" data-type="rules" data-value="${item}" href="#"><i class="bi bi-arrow-return-right"></i> Extract For Rules</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Widget Rules</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" data-type="widget-filter" data-value="${item}" href="#"><i class="bi bi-arrow-return-right"></i> Extract For Filter</a></li>
                    <li><a class="dropdown-item" data-type="widget-fixed-product" data-value="${item}" href="#"><i class="bi bi-arrow-return-right"></i> Extract Fixed Product</a></li>
                </ul>
            `;
            document.getElementById('resultOfJson').append(li);
      });
  }

  function clearForNewExcel() {
      $(document).find(".added-after").remove();
      $(document).find('#xlx_html').empty()
      $(document).find('#loadedSheetNames').empty();
      stateObject = {};
      return true;
  }

  function handleFileSelect(evt) {
    var files = evt.target.files; 
    var xl2json = new ExcelToJSON();
    xl2json.parseExcel(files[0]);
  }

  function copyAll() {
        var copyText = document.getElementById("xlx_html");
        copyText.select();
        document.execCommand("copy");
        alert("Kupon kodunuz kopyalanmıştır");
  }

   function getJsonData() {
        var elem = document.getElementById("xlx_html");
        elem.innerHTML = "";
        elem.innerHTML = JSON.stringify(stateObject);
   }

   function getSheet(sheetName) {
      return stateObject[sheetName];
   }

   function setActiveRules(filterName, ruleType) {
        var clickedRule = $(document).find(`#resultOfJson .dropdown-item[data-value='${filterName}'][data-type='${ruleType}']`);
        var clickedParent = $(document).find(`#resultOfJson .added-after[data-value='${filterName}']`);

        if (!clickedParent.hasClass('active')) {
          $(document).find(`#resultOfJson .added-after.active`).removeClass('active');
          clickedParent.addClass('active');
        }

        if (!clickedRule.hasClass('active')) {
          $(document).find(`#resultOfJson .dropdown-item.active`).removeClass('active');
          clickedRule.addClass('active');
        }
   }  

  function handleJSONObject(e) {
    e.preventDefault();
    var elem = document.getElementById("xlx_html");
    elem.innerHTML = "";
    var type = e.target.dataset.type;
    var filterName = e.target.dataset.value;
    var activeSheet = $(document).find("#loadedSheetNames .nav-link.active").attr('data-value');
    setActiveRules(filterName, type);
    var sheet = getSheet(activeSheet);

    if (type == 'array') {
        var newArr = [];
        sheet.forEach(function(item) {
            newArr.push(item[filterName]);
        });
        elem.innerHTML = JSON.stringify(newArr);
    } else if (type == 'rules') {
        var length = sheet.length;
        var i=0;
        while (length--) {
            elem.innerHTML += sheet[i][filterName] + '\r\n';
            i++;
        }
    } else if (type == 'widget-filter') {
        var length = sheet.length;
        var i=0;
        while (length--) {
            elem.innerHTML += sheet[i][filterName] + ',';
            i++;
        }
        elem.innerHTML = elem.innerHTML.slice(0, -1);
    } else if (type == 'widget-fixed-product') {
        var length = sheet.length;
        var i=0;
        while (length--) {
            elem.innerHTML += sheet[i][filterName] + ';';
            i++;
        }
        elem.innerHTML = elem.innerHTML.slice(0, -1);
    }
  }
</script>
</body>
</html>